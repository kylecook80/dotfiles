#!/bin/bash

if [[ -f "$HOME/.private" ]]; then . $HOME/.private; fi

OS=`echo $(uname) | tr '[:upper:]' '[:lower:]'`
# DIR="$( cd "$( dirname "${BASH_SOURCE[1]}" )" && pwd )"
DIR="$HOME/.dotfiles"

ECHO="/bin/echo -n"

echo "OS: $OS"
echo "DIR: $DIR"

if [ "$OS" = "darwin" ]; then
    DEFAULT_FILES="aliases gitconfig gitignore templates vimrc zshenv zshrc zsh"
else
    DEFAULT_FILES="aliases gdbinit gitconfig gitignore screenrc templates vimrc zshenv zshrc zsh"
fi

#DESKTOP_FILES="i3 polybar rofi xinitrc xmodmaprc Xresources Xresources.d"

install_dotfiles() {
    for item in $DEFAULT_FILES; do
        if [[ -e "$item-$OS" ]]; then
            set -- "$@" "$item-$OS"
        else
            set -- "$@" "$item"
        fi
    done

    regex=".*-$OS"
    for item do
        if echo "$item" | grep -q $regex; then
            file=$(echo "$item" | cut -d'-' -f1)
            $ECHO "Creating file .$file: "
            if [[ ! -e "$HOME/.$file" ]]; then
                cat "$file" "$item" | envsubst > "$HOME/.$file"
                echo "Success"
            else
                echo "Already exists"
            fi
        else
            # echo "no_regex: %s\n" "$HOME/.$item"
            # ln -s ".dotfiles/$item" "$HOME/.$item"
            $ECHO "Linking file .$item: "
            if [[ ! -e "$HOME/.$item" && ! -L "$HOME/.$item" ]]; then
                ln -sf "$DIR/$item" "$HOME/.$item"
                echo "Success"
            else
                echo "Already exists"
            fi
        fi
    done
}

install_scripts() {
    mkdir -p $HOME/bin
    regex=".*-gen\.sh"
    for item in $DIR/scripts/*; do
        if echo "$item" | grep -q $regex; then
            file="$(basename $(echo "$item" | cut -d'-' -f1)).sh"
            $ECHO "Generating script $file.sh: "
            if [[ ! -e "$HOME/bin/$file" ]]; then
                cat "$item" | envsubst > "$HOME/bin/$file"
                echo "Success"
            else
                echo "Already exists"
            fi
        else
            file="$(basename $item)"
            $ECHO "Installing $(basename $item): "
            if [[ ! -L "$HOME/bin/$file" ]]; then
                ln -sf $item $HOME/bin
                echo "Success"
            else
                echo "Already exists"
            fi
        fi
    done
}

install_sublime_prefs() {
    $ECHO "Installing Sublime Text 3 Preferences: "

    SUBFILES=("$HOME/Library/Application Support/Sublime Text 3/Packages/User/Preferences.sublime-settings"
        "$HOME/Library/Application Support/Sublime Text 3/Packages/User/Package Control.sublime-settings")

    if [[ "$OS" = "darwin" ]]; then
        OP=""
        for ((i = 0; i < ${#SUBFILES[@]}; i++)); do
            FILE=${SUBFILES[$i]}
            NAME=$(basename "$FILE")

            if [ -L "$FILE" ]; then
                continue
            fi

            OP=0

            if [ -e "$FILE" ]; then
                mv "$HOME/Library/Application Support/Sublime Text 3/Packages/User/${NAME}" "${HOME}/Library/Application Support/Sublime Text 3/Packages/User/${NAME}.old"
            fi

            ln -s "$HOME/.dotfiles/${NAME}" "${HOME}/Library/Application Support/Sublime Text 3/Packages/User/${NAME}"
        done

        if [[ -z "$OP" ]]; then
            echo "Already exists. Skipping..."
        else
            echo "Success"
        fi
    else
        echo "Operating System not supported."
    fi
}

install_brew_apps() {
    if ! hash brew; then
        echo "Installing X Code CLI tools"
        xcode-select --install
        echo "Installing Homebrew..."
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    # Make sure we’re using the latest Homebrew
    brew update

    # Upgrade any already-installed formulae
    brew upgrade

    apps=(
        autojump
        automake
        binutils
        check
        cmake
        coreutils
        ctags
        curl
        curl-openssl
        diff-so-fancy
        findutils
        gcc
        git
        gnupg
        htop
        iperf
        iperf3
        ipmitool
        jq
        llvm
        make
        mosh
        nasm
        neofetch
        nmap
        ocaml
        p7zip
        packer
        pandoc-citeproc
        pandoc-crossref
        percol
        postgresql
        rbenv
        ruby-build
        sc-im
        socat
        telnet
        tmux
        vim
        wakeonlan
        wget
        wireguard-tools
        zsh
        zsh-autosuggestions
    )
    brew install "${apps[@]}"

    # Remove outdated versions from the cellar
    brew cleanup
}

install_brew_cask() {
    echo “Installing cask...”
    brew tap homebrew/cask
    brew tap homebrew/cask-fonts
    brew tap puppetlabs/puppet

    CASKS=(
        1password
        adoptopenjdk8
        arq
        bettertouchtool
        daisydisk
        discord
        firefox
        font-fira-code
        font-fira-mono
        font-fira-sans
        font-hack
        font-inconsolata
        forklift
        gpg-suite-no-mail
        iterm2
        karabiner-elements
        mactex
        menumeters
        microsoft-office
        mountain
        nextcloud
        sdformatter
        signal
        slack
        soundflower
        sublime-text
        texstudio
        tunnelblick
        ultimaker-cura
        vagrant
        vagrant-vmware-utility
        vmware-fusion
        wireshark
        zotero
    )

    echo “Installing cask apps...”
    brew cask install ${CASKS[@]}
}

install_dotfiles
install_scripts

if [[ "$OS" == "darwin" && ! -e $HOME/.dotinstalled ]]; then
	install_brew_apps
	install_brew_cask
    install_sublime_prefs
fi

# Canary to tell if dotfiles is installed
if [[ ! -e "$HOME/.dotinstalled" ]]; then
    date > $HOME/.dotinstalled
fi
