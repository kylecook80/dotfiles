_spin()
{
    local i=1
    local sp="/-\|"
    local n=${#sp}
    printf " "
    while true; do
        printf '\b%s' "${sp:i++%n:1}"
        sleep 0.5
    done
}

_prog()
{
    _spin & progpid=$!
}

_progend()
{
    if [[ ! -z "${progpid+x}" ]]; then
        kill "${progpid}"
    fi
    printf '\b'
}

task()
{
    TASK_ACTIVE="T"
    echo -n "[ ${lbluef}$1${reset} ]: "
    _prog
}

taskerror()
{
    _progend
    if [[ "${TASK_ACTIVE}" = "T" ]]; then
        echo "${lredf}$1${reset}"
        unset TASK_ACTIVE
    fi
}

taskdone()
{
    _progend
    if [[ "${TASK_ACTIVE}" = "T" ]]; then
        echo "${lgreenf}Complete${reset}"
        unset TASK_ACTIVE
    fi
}

run()
{
    if [[ -z "${RUN_STATUS+x}" ]]; then
        echo ""
        msg "COMMAND" "$@"
        "$@" || RUN_STATUS=$?
    fi
}

check()
{
    if [[ "${RUN_STATUS}" = "${1}" ]]; then
        CHECK_ERROR="${1}"

        if [[ "${TASK_ACTIVE}" = "Y" ]]; then
            taskerror "$2"
        else
            error "$2"
        fi
    fi
}

checkdone()
{
    unset RUN_STATUS
}

checkexit()
{
    if [[ ! -z "${CHECK_ERROR}" ]]; then
        _progend
        exit ${CHECK_ERROR}
    fi
    unset RUN_STATUS
}
